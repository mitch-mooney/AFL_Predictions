---
title: "AFL Predictions"
output: html_document
---

# 2021 AFL predictions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE, include=FALSE}
file.source = list.files("functions/")
sapply(paste0('functions/', file.source), source)
source("source_code/AFL_data.R")

```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(keras)

data <- future_data_lean
col_num<-as.numeric(ncol(data))
data[1:col_num] <- lapply(data[1:col_num], as.numeric) #make sure all variables are numeric

# returns a list of matrix used for running model
model.data <- model_data(data)
# trains the model using the data frames you choose from the list target needs to be categorical
model <- load_model_tf("model/model")

```

```{r message=FALSE, warning=FALSE, include=FALSE}
#predict future events targets
pred_new <- model %>% 
  predict_classes(model.data$future_matrix)
#predict target probabilities
prob_future<-model %>% 
  predict_proba(model.data$future_matrix)
future_rows<-as.numeric(nrow(prob_future))
prob_pred_future<-cbind(round(prob_future[1:future_rows,1:model.data$test_dim], 3),
                 pred_new[1:future_rows])
prob_pred_df <- as.data.frame(prob_pred_future)

#put down predictions for all matches to add to score_margin dataframe
data_mat<-rbind(model.data$data, model.data$full_future_matrix)
x<-data_mat[,2:col_num]
all_match_pred<-model %>% predict_proba(x)

score_data_lean<-cbind(score_data_lean, all_match_pred)
score_data_lean<- score_data_lean %>%  
  rename(pred_loss_prob = `1`, pred_win_prob = `2`)


score_data_lean<-score_data_lean %>%
  mutate(pred_cat = ifelse(pred_win_prob < 0.1, 1, 
                           ifelse(pred_win_prob > 0.1 & pred_win_prob < 0.2, 2,
                                  ifelse(pred_win_prob > 0.2 &pred_win_prob < 0.3, 3,
                                         ifelse(pred_win_prob > 0.3 & pred_win_prob < 0.4, 4,
                                                ifelse(pred_win_prob > 0.4 & pred_win_prob < 0.5, 5,
                                                       ifelse(pred_win_prob > 0.5 & pred_win_prob < 0.6, 6,
                                                              ifelse(pred_win_prob > 0.6 & pred_win_prob< 0.7, 7,
                                                                     ifelse(pred_win_prob > 0.7 & pred_win_prob < 0.8, 8,
                                                                            ifelse(pred_win_prob > 0.8 & pred_win_prob < 0.9, 9, 10))))))))))
#make numerical value categories
score_data_lean$pred_cat_factor <- as.factor(score_data_lean$pred_cat)

# New facet label names for supp variable
score_data_lean$pred_cat <- factor(score_data_lean$pred_cat_factor, levels = c(1,2,3,4,5,6,7,8,9,10), 
                          labels = c("0-10%", "10-20%", "20-30%", "30-40%", "40-50%", "50-60%", "60-70%", "70-80%", "80-90%", "90-100%"))

# Find the mean of each group removing the unknown margins
Sum_pred_cat<-score_data_lean %>%
  group_by(pred_cat) %>% 
  filter(Margin != 999) %>% 
  summarise(rating.mean=mean(Margin), rating.sd = sd(Margin))

# linear formula for predicting margin from win probabolity
formula <- lm(Margin ~ pred_win_prob, na.action=na.exclude, data= score_data_lean)
score_data_lean %<>% mutate(margin_est_linear = predict(formula)) # add estimate of margin


```


```{r message=FALSE, warning=FALSE, include=FALSE}
source('source_code/margin_estimate.R')
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=11}
# create plot for simulation
score_sim$score_sim %>% 
  mutate(result = ifelse(value < 0, opp, team)) %>% 
  filter(game < (games/2 +1)) %>% #change this to suit how many matches there are that round
ggplot(aes(x = value, color = result))+
  geom_histogram(binwidth = 1,  alpha = 0.8)+
  geom_vline(data=mean_score[1:(games/2),], aes(xintercept=rating.mean,  colour=result), #change mean_score[1:games/2]
             linetype="dashed", size=1)+
  scale_colour_manual(values = cols)+
  labs(title = paste("Match simulation of AFL:", score_sim$score_sim$round,sep = " "),
       color = "Team",
       x = "simulated margin")+
  scale_x_continuous(breaks = seq(-100, 100, 20))+
  theme_AFL(base_size = 12)+
  facet_grid(game+match~.,labeller = label_wrap_gen(width = 0.5, multi_line = TRUE))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggpubr)
library(reactable)
library(htmltools)
library(sparkline)


new_predictions<-score_sim$score_data_lean %>% 
  filter(Margin == 999) %>% 
  mutate(Tips = ifelse(pred_win_prob > 0.5, 1, 0)) %>% 
  select(Tips,	pred_loss_prob,	pred_win_prob,margin_est_linear,margin_est_rand)

table<-cbind(round, new_predictions)
table$Margin <- NULL

table %<>% 
  mutate(Team_predicted = ifelse(Tips == 1, Team, Opposition))
  
table %<>%
  select(Date,	Match_id,	Season,	Team,	Opposition,	Status,	Venue,	Round,	results,	Odds,	line_Odds,	Opp_Odds,	Opp_lineOdds,	Tips,	pred_loss_prob,	pred_win_prob, Team_predicted,	margin_est_linear,	margin_est_rand) %>% 
  rename(
    Loss_prob = pred_loss_prob,
    Win_Prob = pred_win_prob,
    margin_estimate_1 = margin_est_linear,
    margin_estimate_2 = margin_est_rand
  )

table_final <- table %>% 
  filter(Status == "Home")

table_final %<>% 
  select(Date, Season, Team, Opposition, Venue, Round, Loss_prob, Win_Prob, Team_predicted, margin_estimate_1) %>% 
  mutate(Loss_prob = round(Loss_prob, digits = 2),
         Win_Prob = round(Win_Prob, digits = 2),
         margin_estimate_1 = round(margin_estimate_1, digits = 0))

# generate table to merge with simulation plot
t <- table_final %>% 
  select(Team, Opposition, Round, Loss_prob, Win_Prob, margin_estimate_1, Team_predicted) %>% 
  rename(Pred_Winner=Team_predicted,Pred_Margin = margin_estimate_1)

# use reactable to use team logos
  options(reactable.theme = reactableTheme(
    color = "hsl(233, 9%, 87%)",
    backgroundColor = "hsl(233, 9%, 19%)",
    borderColor = "hsl(233, 9%, 22%)",
    stripedColor = "hsl(233, 12%, 22%)",
    highlightColor = "hsl(233, 12%, 24%)",
    inputStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
    selectStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
    pageButtonHoverStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
    pageButtonActiveStyle = list(backgroundColor = "hsl(233, 9%, 28%)")
  ))

reactable(t, columns = list(
  Team = colDef(maxWidth = 150, align = "center", cell = function(value) {
    img_src <- knitr::image_uri(sprintf("images/%s.png", value))
    image <- img(src = img_src, height = "60px", alt = value)
    tagList(
      div(style = list(display = "inline-block", width = "80px"), image)
    )
    
  }),
  Opposition = colDef(maxWidth = 150, align = "center", cell = function(value) {
    img_src <- knitr::image_uri(sprintf("images/%s.png", value))
    image <- img(src = img_src, height = "60px", alt = value)
    tagList(
      div(style = list(display = "inline-block", width = "80px"), image)
    )
  }),
  Pred_Winner = colDef(name = "Predicted Winner", maxWidth = 150, align = "center", cell = function(value) {
    img_src <- knitr::image_uri(sprintf("images/%s.png", value))
    image <- img(src = img_src, height = "60px", alt = value)
    tagList(
      div(style = list(display = "inline-block", width = "80px"), image)
    )
  }),
  Round = colDef(align = "center", maxWidth = 120),
  Loss_prob = colDef(name = "Loss Probability", align = "center", maxWidth = 120),
  Win_Prob = colDef(name = "Win Probability", align = "center", maxWidth = 120),
  Pred_Margin = colDef(name = "Predicted Margin", align = "center", maxWidth = 120)
))
#rmarkdown::render("predictions.Rmd", "html_document")
```


```{r, echo=FALSE, out.width="10%", out.height="10%", fig.align: "right"}
knitr::include_graphics("images/logo.png")
```
