---
title: "AFL Ratings"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Team Ratings


Using Glicko2 ratings in the PlayerRatings package in R.


```{r message=FALSE, warning=FALSE, include=FALSE}
file.source = list.files("functions/")
sapply(paste0('functions/', file.source), source)
source('source_code/AFL_data.R')
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggpubr)
library(reactable)
library(htmltools)
library(sparkline)

matches<-results %>% 
  filter(Season >= 2010) %>% 
  group_by(Season, Round.Number) %>% 
  summarise_each(funs(n_distinct(Date))) %>% 
  select(Season, Round.Number, Date)

lag <-tail(matches$Date, 1)
round_num <- tail(matches$Round.Number, 1)

#glicko ratings table
rating_history <- glicko %>% 
  filter(var == "Rating") %>% 
  group_by(match) %>% 
  mutate(rank = rank(-value))%>% 
  group_by(Team) %>% 
  mutate(lag = lag(rank, n =lag)) %>% 
  ungroup()%>% 
  mutate(change = ifelse(rank < lag, "Up", ifelse(rank > lag, "Down", "Unchanged")),
         match = as.numeric(match)) %>% 
  filter(match == max(match)) %>% 
  select(Team, change) %>%
  rename(Player = Team)

team_rate <- glicko_rate$ratings
team_rate %<>% 
  select(!c(Lag, Deviation, Volatility)) %>% 
  mutate(Rating = round(Rating, 0), Rank = rank(-Rating)) %>% 
  select(Rank, Player, Rating)

team_rate<-left_join(rating_history, team_rate, by = c("Player"))

spark_table <- glicko_clean %>%
  group_by(Team) %>%
  summarise(Rating = round(tail(value, n = 1), 0),sparkline = list(tail(value, n = round_num))) %>% 
  rename(Player = Team)

spark_table <- merge(team_rate,spark_table, by=c("Rating", "Player"), all.x=TRUE, all.y=TRUE)

reactable_function(data = spark_table)

```

```{r, echo=FALSE, out.width="10%", out.height="10%", fig.align: "right"}
knitr::include_graphics("images/logo.png")
```

